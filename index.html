<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root { --pea-purple: #7B1FA2; --pea-purple-light: #F3E5F5; --pea-purple-hover: #9C27B0; }
    body { background-color: var(--pea-purple-light); font-family: 'Sarabun', sans-serif; padding: 15px; }
    .text-pea { color: var(--pea-purple) !important; }
    .bg-pea { background-color: var(--pea-purple) !important; color: white; }
    .btn-pea { background-color: var(--pea-purple); color: white; border-radius: 6px; }
    .btn-pea:hover { background-color: var(--pea-purple-hover); color: white; }
    .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .card-header { border-radius: 12px 12px 0 0 !important; }
    .timeline-container { height: 650px; overflow-y: auto; padding: 5px; }
    .timeline-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 12px; border-left: 6px solid #ccc; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: 0.3s;}
    .timeline-card:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.1); transform: translateY(-2px); }
    .border-yellow { border-color: #f1c40f !important; }
    .border-purple { border-color: #9b59b6 !important; }
    .border-green { border-color: #2ecc71 !important; }
    .nav-tabs .nav-link { color: #555; font-weight: 500; border-radius: 8px 8px 0 0; }
    .nav-tabs .nav-link.active { color: var(--pea-purple); font-weight: bold; border-bottom: 3px solid var(--pea-purple); }
  </style>
</head>
<body>

<div class="container-fluid" style="max-width: 1300px;">
  <div class="text-center mb-4 mt-2">
    <h2 class="fw-bold text-pea">‚ö° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå Car pool ‡∏Å‡∏™‡∏ü.(‡∏ô2)</h2>
    <p class="text-danger fw-bold">‡∏´‡∏≤‡∏Å‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏ß‡∏•‡∏≤) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î</p>
  </div>

  <div class="row">
    <div class="col-lg-5 mb-4">
      <div class="card h-100">
        <div class="card-header bg-pea fw-bold fs-5">üìù ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ</div>
        <div class="card-body">
          <form id="bookingForm" class="row g-3">
            <input type="hidden" id="rowId">
            <div class="col-md-6">
              <label class="form-label fw-bold small">‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</label>
              <select id="type" class="form-select" required>
                <option value="‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå">‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</option>
                <option value="‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå">‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold small text-pea">‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå Car pool</label>
              <select id="car" class="form-select border-primary" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå --</option>
                <option value="üü° 7‡∏Ç‡∏Ü 1370 ‡∏Å‡∏ó‡∏°.">üü° 7‡∏Ç‡∏Ü 1370 ‡∏Å‡∏ó‡∏°.</option>
                <option value="üü£ 3‡∏Ç‡∏ô 8046 ‡∏Å‡∏ó‡∏°.">üü£ 3‡∏Ç‡∏ô 8046 ‡∏Å‡∏ó‡∏°.</option>
                <option value="üü¢ 4‡∏Ç‡∏´ 1270 ‡∏Å‡∏ó‡∏°.">üü¢ 4‡∏Ç‡∏´ 1270 ‡∏Å‡∏ó‡∏°.</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label small">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</label>
              <input type="text" id="name" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
              <input type="text" id="phone" class="form-control" required>
            </div>
            <div class="col-12">
              <label class="form-label small">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</label>
              <div class="input-group">
                <input type="text" id="dept" class="form-control" placeholder="‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î" required>
                <input type="text" id="job" class="form-control" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ" required>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label text-success fw-bold small">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
              <input type="datetime-local" id="start" class="form-control border-success" required>
            </div>
            <div class="col-md-6">
              <label class="form-label text-danger fw-bold small">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
              <input type="datetime-local" id="end" class="form-control border-danger" required>
            </div>
            <div class="col-12">
              <div class="form-check alert alert-warning py-2 mb-0 d-flex align-items-center">
                <input class="form-check-input ms-1 me-2" type="checkbox" id="check" required>
                <label class="form-check-label text-danger fw-bold small">‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ñ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏à‡∏≠‡∏á</label>
              </div>
            </div>
            <div class="col-12 d-grid gap-2 mt-4">
              <button type="submit" class="btn btn-pea btn-lg fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
              <button type="button" onclick="resetForm()" class="btn btn-light">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="card h-100">
        <div class="card-header bg-white pb-0 border-bottom-0">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold mb-0 text-pea">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ñ (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)</h5>
            <input type="text" id="search" class="form-control form-control-sm w-50" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠/‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î...">
          </div>
          <ul class="nav nav-tabs" id="carTabs" role="tablist">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-car1">üü° 7‡∏Ç‡∏Ü</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-car2">üü£ 3‡∏Ç‡∏ô</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-car3">üü¢ 4‡∏Ç‡∏´</a></li>
          </ul>
        </div>
        <div class="card-body bg-light">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-all"><div id="list-all" class="timeline-container"></div></div>
            <div class="tab-pane fade" id="tab-car1"><div id="list-car1" class="timeline-container"></div></div>
            <div class="tab-pane fade" id="tab-car2"><div id="list-car2" class="timeline-container"></div></div>
            <div class="tab-pane fade" id="tab-car3"><div id="list-car3" class="timeline-container"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let allData = [];

  document.addEventListener('DOMContentLoaded', function() {
    loadData();
    document.getElementById('bookingForm').addEventListener('submit', handleFormSubmit);
    document.getElementById('search').addEventListener('input', filterData);
  });

  // üõ°Ô∏è ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô 00:00:00 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ß‡∏±‡∏ô)
  function getDateOnlyTime(val) {
    if (!val) return 0;
    let str = String(val).trim().split('T')[0].split(' ')[0].split(',')[0];
    let d;
    if (str.includes('-')) {
      let p = str.split('-');
      d = new Date(parseInt(p[0]), parseInt(p[1])-1, parseInt(p[2]));
    } else if (str.includes('/')) {
      let p = str.split('/');
      if (p[0].length === 4) d = new Date(parseInt(p[0]), parseInt(p[1])-1, parseInt(p[2]));
      else d = new Date(parseInt(p[2]), parseInt(p[1])-1, parseInt(p[0]));
    } else {
      d = new Date(val);
    }
    if (isNaN(d.getTime())) return 0;
    let y = d.getFullYear();
    if (y > 2500) d.setFullYear(y - 543);
    else if (y < 100) d.setFullYear(y + 2000);
    
    d.setHours(0, 0, 0, 0); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏¥‡πâ‡∏á
    return d.getTime();
  }

  function loadData() {
    document.getElementById('list-all').innerHTML = '<div class="text-center mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
    google.script.run.withSuccessHandler(function(res) {
      allData = res;
      renderTabs(res);
    }).getData();
  }

  function getCarStyles(carName) {
    if(carName.includes('7‡∏Ç‡∏Ü')) return 'border-yellow';
    if(carName.includes('3‡∏Ç‡∏ô')) return 'border-purple';
    if(carName.includes('4‡∏Ç‡∏´')) return 'border-green';
    return 'border-secondary';
  }

  function renderTabs(data) {
    let now = new Date().getTime();
    
    // ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á)
    let activeData = data.filter(item => {
      let eDate = new Date(item.end).getTime();
      return !isNaN(eDate) && eDate >= now; 
    });

    activeData.sort((a, b) => new Date(a.start).getTime() - new Date(b.start).getTime());

    let dataCar1 = activeData.filter(d => d.car.includes('7‡∏Ç‡∏Ü'));
    let dataCar2 = activeData.filter(d => d.car.includes('3‡∏Ç‡∏ô'));
    let dataCar3 = activeData.filter(d => d.car.includes('4‡∏Ç‡∏´'));

    buildList('list-all', activeData);
    buildList('list-car1', dataCar1);
    buildList('list-car2', dataCar2);
    buildList('list-car3', dataCar3);
  }

  function buildList(containerId, dataArray) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    if(dataArray.length === 0) {
      container.innerHTML = '<div class="alert alert-light text-center mt-3 text-muted border">‚ú® ‡∏ß‡πà‡∏≤‡∏á / ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>';
      return;
    }

    dataArray.forEach(item => {
      const bColor = getCarStyles(item.car);
      let sDate = new Date(item.start);
      let eDate = new Date(item.end);
      let sText = isNaN(sDate.getTime()) ? item.start : sDate.toLocaleString('th-TH').slice(0, 16);
      let eText = isNaN(eDate.getTime()) ? item.end : eDate.toLocaleString('th-TH').slice(0, 16);

      const card = document.createElement('div');
      card.className = `timeline-card ${bColor}`;
      card.innerHTML = `
        <div class="d-flex justify-content-between align-items-start mb-2">
          <span class="fw-bold fs-6 text-dark">${item.car}</span>
          <span class="badge bg-light text-dark border">${item.type}</span>
        </div>
        <div class="row mb-1">
          <div class="col-sm-7">
            <h5 class="fw-bold text-pea mb-1">üë§ ${item.name}</h5>
            <div class="text-muted small">üè¢ ${item.dept} | üìû ${item.phone}</div>
            <div class="text-dark small mt-1">üìç <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</b> ${item.job}</div>
          </div>
          <div class="col-sm-5 text-sm-end text-start mt-2 mt-sm-0 bg-light p-2 rounded">
            <div class="text-success small fw-bold">üü¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°: ${sText}</div>
            <div class="text-danger small fw-bold mt-1">üî¥ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: ${eText}</div>
          </div>
        </div>
        <div class="text-end mt-2">
          <button class="btn btn-sm btn-outline-warning px-3 py-0" onclick="editData(${item.rowId})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn btn-sm btn-outline-danger px-3 py-0 ms-1" onclick="deleteData(${item.rowId})">‡∏•‡∏ö</button>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function handleFormSubmit(e) {
    e.preventDefault();
    
    const rowId = document.getElementById('rowId').value;
    const car = document.getElementById('car').value;
    const startInput = document.getElementById('start').value;
    const endInput = document.getElementById('end').value;
    
    // üõ°Ô∏è ‡∏î‡∏∂‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡∏°‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô (‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô)
    const newStart = getDateOnlyTime(startInput);
    const newEnd = getDateOnlyTime(endInput);
    
    if (newEnd < newStart) {
      Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'warning');
      return;
    }

    let isOverlapped = false;
    
    for (let i = 0; i < allData.length; i++) {
      let item = allData[i];
      if (rowId && String(item.rowId) === String(rowId)) continue;
      
      if (item.car === car) {
        let existStart = getDateOnlyTime(item.start);
        let existEnd = getDateOnlyTime(item.end);
        
        if (existStart === 0 || existEnd === 0) continue;
        
        // üî¥ ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)
        if (newStart <= existEnd && newEnd >= existStart) {
          isOverlapped = true;
          break;
        }
      }
    }

    // ‚õî ‡πÄ‡∏î‡πâ‡∏á POP UP ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ä‡∏ô‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Return)
    if (isOverlapped) {
      Swal.fire({
        title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ!',
        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô',
        icon: 'error',
        confirmButtonColor: '#d33',
        confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö'
      });
      return; 
    }

    const btn = e.submitter;
    btn.disabled = true;
    btn.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

    const obj = {
      rowId: rowId,
      type: document.getElementById('type').value,
      car: car,
      name: document.getElementById('name').value,
      phone: document.getElementById('phone').value,
      dept: document.getElementById('dept').value,
      job: document.getElementById('job').value,
      start: startInput, 
      end: endInput,
      check: document.getElementById('check').checked ? "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß" : ""
    };

    google.script.run.withSuccessHandler(function(res) {
      btn.disabled = false;
      btn.innerHTML = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
      
      // üî¥ ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Server ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏≠‡∏ö‡∏´‡∏•‡∏∏‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ (‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2)
      if(res.status === "error") {
        Swal.fire({
          title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ!',
          text: res.message,
          icon: 'error',
          confirmButtonColor: '#d33',
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
        });
        allData = res.data;
        renderTabs(res.data);
      } else {
        Swal.fire({ title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', icon: 'success', timer: 1500, showConfirmButton: false });
        resetForm();
        allData = res.data;
        renderTabs(res.data); 
      }
    }).saveBooking(obj);
  }

  function editData(rowId) {
    const item = allData.find(d => d.rowId === rowId);
    document.getElementById('rowId').value = item.rowId;
    document.getElementById('type').value = item.type;
    document.getElementById('car').value = item.car;
    document.getElementById('name').value = item.name;
    document.getElementById('phone').value = item.phone;
    document.getElementById('dept').value = item.dept;
    document.getElementById('job').value = item.job;
    
    if(item.start) document.getElementById('start').value = item.start.substring(0, 16);
    if(item.end) document.getElementById('end').value = item.end.substring(0, 16);
    
    document.getElementById('check').checked = true;
    document.getElementById('bookingForm').scrollIntoView({behavior: 'smooth'});
  }

  function deleteData(rowId) {
    Swal.fire({
      title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
      text: "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      confirmButtonText: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        google.script.run.withSuccessHandler(function(res) {
          Swal.close();
          allData = res;
          renderTabs(res);
        }).deleteBooking(rowId);
      }
    });
  }

  function filterData() {
    const val = this.value.toLowerCase();
    const filtered = allData.filter(d => 
      (d.name && d.name.toLowerCase().includes(val)) || 
      (d.dept && d.dept.toLowerCase().includes(val)) || 
      (d.job && d.job.toLowerCase().includes(val))
    );
    renderTabs(filtered);
  }

  function resetForm() {
    document.getElementById('bookingForm').reset();
    document.getElementById('rowId').value = '';
  }
</script>
</body>
</html>
